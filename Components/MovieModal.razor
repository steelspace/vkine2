@using vkine.Models
@using vkine.Services
@using Microsoft.AspNetCore.Components.Web
@inject IScheduleService ScheduleService
@inject IJSRuntime JS

@if (IsOpen && Movie != null)
{
    <div @ref="backdropRef" data-testid="movie-modal" class="modal-backdrop" @onclick="OnClose" @onkeydown="HandleKeyDown" tabindex="-1">
        <div class="modal-wrapper">
            <button data-testid="modal-close" class="modal-close" @onclick="OnClose" @onclick:stopPropagation="true">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div data-testid="movie-modal-content" class="modal-content @( !string.IsNullOrEmpty(Movie?.BackdropUrl) ? "has-backdrop" : "")" @onclick:stopPropagation="true">
            <div class="modal-hero">
                @if (!string.IsNullOrEmpty(Movie.BackdropUrl))
                {
                    var backdropSrc = Movie.BackdropUrl;
                    try
                    {
                        var uri = new Uri(backdropSrc);
                        if (string.Equals(uri.Host, "image.tmdb.org", StringComparison.OrdinalIgnoreCase))
                        {
                            backdropSrc = $"/proxy/tmdb{uri.AbsolutePath}";
                        }
                    }
                    catch { /* if parse fails, just use original */ }

                    <div class="modal-backdrop-image">
                        <img data-testid="modal-backdrop-img" src="@backdropSrc" alt="@Movie.Title backdrop" crossorigin="anonymous" onload="requestAnimationFrame(() => { this.classList.add('loaded'); vkineMovie.analyzeBackdrop(this, '[data-testid=movie-modal-content]'); })" onerror="vkineMovie.clearBackdropClass('[data-testid=movie-modal-content]')" />
                    </div>
                }
                else
                {
                    <div class="modal-grabber"></div>
                }
                <div class="modal-header">
                    <h2 data-testid="modal-title">
                        @if (!string.IsNullOrEmpty(Movie.Homepage))
                        {
                            <a data-testid="modal-title-link" href="@Movie.Homepage" target="_blank" class="movie-title-link">@Movie.Title</a>
                        }
                        else
                        {
                            @Movie.Title
                        }
                    </h2>
                </div>
                <div class="modal-hero-details">
                    <div class="modal-meta">
                        @if (!string.IsNullOrEmpty(Movie.Year))
                        {
                            <span data-testid="modal-year" class="meta-item">@Movie.Year</span>
                        }
                        @if (!string.IsNullOrEmpty(Movie.Duration))
                        {
                            <span data-testid="modal-duration" class="meta-item">@Movie.Duration</span>
                        }
                        @if (Movie.OriginCountries.Count > 0)
                        {
                            <span data-testid="modal-countries" class="meta-item">@string.Join(", ", Movie.OriginCountries)</span>
                        }
                    </div>

                    <div class="modal-ratings">
                        @if (Movie.Id > 0)
                        {
                            <a href="https://www.csfd.cz/film/@Movie.Id" target="_blank" class="rating-badge csfd" title="CSFD rating">
                                <span class="rating-source">ČSFD</span>
                                @if (!string.IsNullOrEmpty(Movie.CsfdRating))
                                {
                                    <span class="rating-value">@Movie.CsfdRating</span>
                                }
                            </a>
                        }
                        @if (Movie.TmdbId.HasValue)
                        {
                            <a href="https://www.themoviedb.org/movie/@Movie.TmdbId" target="_blank" class="rating-badge tmdb" title="TMDB rating">
                                <span class="rating-source">TMDB</span>
                                @if (Movie.TmdbRating.HasValue)
                                {
                                    <span class="rating-value">@Movie.TmdbRating.Value.ToString("0.#")</span>
                                }
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(Movie.ImdbId))
                        {
                            <a href="https://www.imdb.com/title/@Movie.ImdbId" target="_blank" class="rating-badge imdb" title="@(Movie.ImdbRatingCount.HasValue ? $"IMDb rating ({Movie.ImdbRatingCount.Value:N0} votes)" : "View on IMDb")">
                                <span class="rating-source">IMDb</span>
                                @if (Movie.ImdbRating.HasValue)
                                {
                                    <span class="rating-value">@Movie.ImdbRating.Value.ToString("0.#")</span>
                                }
                            </a>
                        }
                    </div>

                </div>
            </div>
            <div class="modal-body">
                <div class="modal-details">
                    @if (!string.IsNullOrEmpty(Movie.Synopsis))
                    {
                        <div data-testid="modal-synopsis" class="modal-synopsis">
                            <span class="section-label">Synopsis</span>
                            <p>@Movie.Synopsis</p>
                        </div>
                    }

                    @if (Movie.Directors.Count > 0)
                    {
                        <div class="modal-info-row">
                            <span class="section-label">Director</span>
                            <span>
                                @for (int i = 0; i < Movie.Directors.Count; i++)
                                {
                                    @if (i > 0) { <text>, </text> }
                                    <a href="https://www.google.com/search?q=@Uri.EscapeDataString(Movie.Directors[i])" target="_blank" class="person-link">@Movie.Directors[i]</a>
                                }
                            </span>
                        </div>
                    }

                    @if (Movie.Cast.Count > 0)
                    {
                        <div class="modal-people">
                            <span class="section-label">Cast</span>
                            <p>
                                @for (int i = 0; i < Movie.Cast.Count; i++)
                                {
                                    @if (i > 0) { <text>, </text> }
                                    <a href="https://www.google.com/search?q=@Uri.EscapeDataString(Movie.Cast[i])" target="_blank" class="person-link">@Movie.Cast[i]</a>
                                }
                            </p>
                        </div>
                    }

                    @if (Movie.Crew.Count > 0)
                    {
                        <div class="modal-people">
                            <span class="section-label">Crew</span>
                            <p>
                                @for (int i = 0; i < Movie.Crew.Count; i++)
                                {
                                    @if (i > 0) { <text>, </text> }
                                    <a href="https://www.google.com/search?q=@Uri.EscapeDataString(Movie.Crew[i])" target="_blank" class="person-link">@Movie.Crew[i]</a>
                                }
                            </p>
                        </div>
                    }

                    @if (YouTubeVideoId is not null)
                    {
                        <div class="trailer-section">
                            <span class="section-label">Trailer</span>
                            <div class="trailer-player">
                                <iframe src="https://www.youtube.com/embed/@YouTubeVideoId?rel=0&modestbranding=1&showinfo=0&iv_load_policy=3&disablekb=1&fs=1&color=white"
                                        title="Trailer"
                                        loading="lazy"
                                        referrerpolicy="no-referrer-when-downgrade"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                        allowfullscreen></iframe>
                            </div>
                        </div>
                    }

                    @if (isLoadingSchedules)
                    {
                        <div data-testid="modal-loading" class="modal-loading">
                            <p>Loading showtimes...</p>
                        </div>
                    }
                    else if (schedules != null && schedules.Count > 0)
                    {
                        <div data-testid="modal-schedules" class="modal-schedules">
                            <h3>Upcoming Showtimes</h3>
                            @if (HasActiveFilters)
                            {
                                <div class="filter-banner">
                                    <span class="filter-banner-icon">&#9888;</span>
                                    Showing only showtimes matching active filters: @FilterSummary
                                </div>
                            }
                            @foreach (var schedule in schedules)
                            {
                                <div class="schedule-date">
                                    <h4 data-testid="schedule-date">@schedule.Date.ToString("dddd, MMMM dd, yyyy")</h4>
                                    @foreach (var performance in schedule.Performances)
                                    {
                                        <div data-testid="performance" class="performance">
                                            @if (venues.TryGetValue(performance.VenueId, out var venue))
                                            {
                                                <div class="venue-info">
                                                    <strong>@venue.Name</strong>
                                                    @if (!string.IsNullOrEmpty(venue.City))
                                                    {
                                                        <span class="venue-city"> - @venue.City</span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="venue-info">
                                                    <strong>Venue ID: @performance.VenueId</strong>
                                                </div>
                                            }
                                            <div class="showtimes">
                                                @foreach (var showtime in performance.Showtimes)
                                                {
                                                    <div data-testid="showtime" class="showtime @(showtime.TicketsAvailable ? "available" : "unavailable")">
                                                        <span class="time">
                                                            @showtime.StartAt.ToString("HH:mm")
                                                        </span>
                                                        @if (showtime.Badges.Count > 0)
                                                        {
                                                            <span class="badges">
                                                                @foreach (var badge in showtime.Badges)
                                                                {
                                                                    <span class="badge" title="@badge.Description">@badge.Code</span>
                                                                }
                                                            </span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(showtime.TicketUrl) && showtime.TicketsAvailable)
                                                        {
                                                            <a data-testid="ticket-link" href="@showtime.TicketUrl" target="_blank" class="ticket-link">Buy Tickets</a>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else if (!isLoadingSchedules)
                    {
                        <div data-testid="modal-no-schedules" class="no-schedules">
                            <p>No upcoming showtimes available.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public Movie? Movie { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public DateOnly? DateFrom { get; set; }

    [Parameter]
    public DateOnly? DateTo { get; set; }

    [Parameter]
    public TimeOnly? TimeFrom { get; set; }

    private bool HasActiveFilters => DateFrom.HasValue || DateTo.HasValue || TimeFrom.HasValue;

    private string? YouTubeVideoId => ExtractYouTubeVideoId(Movie?.TrailerUrl);

    private static string? ExtractYouTubeVideoId(string? url)
    {
        if (string.IsNullOrWhiteSpace(url)) return null;
        // Handles youtube.com/watch?v=ID, youtu.be/ID, youtube.com/embed/ID
        var match = System.Text.RegularExpressions.Regex.Match(url,
            @"(?:youtube\.com/(?:watch\?.*v=|embed/)|youtu\.be/)([\w-]{11})");
        return match.Success ? match.Groups[1].Value : null;
    }

    private string FilterSummary
    {
        get
        {
            var parts = new List<string>();
            if (DateFrom.HasValue && DateTo.HasValue)
                parts.Add($"{DateFrom.Value:MMM d} – {DateTo.Value:MMM d, yyyy}");
            if (TimeFrom.HasValue)
                parts.Add($"after {TimeFrom.Value:HH:mm}");
            return string.Join(", ", parts);
        }
    }

    private ElementReference backdropRef;
    private List<ScheduleDto>? schedules;
    private Dictionary<int, VenueDto> venues = new();
    private bool isLoadingSchedules = false;

    private bool _wasOpen;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsOpen && Movie != null)
        {
            try { await backdropRef.FocusAsync(); } catch { }
            if (!_wasOpen)
            {
                _wasOpen = true;
                await JS.InvokeVoidAsync("vkineMovie.lockScroll");
            }
        }
        else if (_wasOpen)
        {
            _wasOpen = false;
            await JS.InvokeVoidAsync("vkineMovie.unlockScroll");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen && Movie != null && Movie.Id > 0)
        {
            await LoadSchedulesAsync();
        }
        else if (!IsOpen)
        {
            // Clear data when modal is closed
            schedules = null;
            venues.Clear();
        }
    }

    private async Task LoadSchedulesAsync()
    {
        try
        {
            isLoadingSchedules = true;
            schedules = await ScheduleService.GetUpcomingPerformancesForMovieAsync(Movie!.Id);

            // Apply date range filter
            if (DateFrom.HasValue && DateTo.HasValue)
            {
                schedules = schedules
                    .Where(s => s.Date >= DateFrom.Value && s.Date <= DateTo.Value)
                    .ToList();
            }

            // Apply time-of-day filter
            if (TimeFrom.HasValue)
            {
                foreach (var schedule in schedules)
                {
                    foreach (var performance in schedule.Performances)
                    {
                        performance.Showtimes = performance.Showtimes
                            .Where(st => st.StartAt >= TimeFrom.Value)
                            .ToList();
                    }

                    schedule.Performances = schedule.Performances
                        .Where(p => p.Showtimes.Count > 0)
                        .ToList();
                }

                schedules = schedules
                    .Where(s => s.Performances.Count > 0)
                    .ToList();
            }

            if (schedules != null && schedules.Count > 0)
            {
                var venueIds = schedules
                    .SelectMany(s => s.Performances)
                    .Select(p => p.VenueId)
                    .Distinct()
                    .ToList();

                venues = await ScheduleService.GetVenuesByIdsAsync(venueIds);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading schedules: {ex.Message}");
            schedules = new List<ScheduleDto>();
        }
        finally
        {
            isLoadingSchedules = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // close modal on Escape (window-level key handler registered only while modal is rendered)
        if (e is not null && (e.Key == "Escape" || e.Key == "Esc"))
        {
            await OnClose.InvokeAsync();
        }
    }
}
