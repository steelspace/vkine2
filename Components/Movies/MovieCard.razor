@{
    var cardTitle = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "cs" || string.IsNullOrEmpty(Movie.TitleEn) ? Movie.Title : Movie.TitleEn;
    var initials = GetInitials(cardTitle);
    var backgroundStyle = GetGradientStyle(cardTitle ?? Movie.Id.ToString());
}

<div data-testid="movie-card" class="movie-card loaded @(LazyLoad ? "lazy-load" : "")" data-movie-id="@Movie.Id" @onclick="OnClick">
    <div class="movie-poster">
        @if (!string.IsNullOrEmpty(Movie.CoverUrl))
        {
            <img data-testid="movie-poster-img" src="@Movie.CoverUrl" alt="@Movie.Title" loading="@(LazyLoad ? "lazy" : "eager")" />
        }
        else if (!string.IsNullOrEmpty(Movie.BackdropUrl))
        {
            <img data-testid="movie-poster-img" class="backdrop-as-poster" src="@Movie.BackdropUrl" alt="@Movie.Title" loading="@(LazyLoad ? "lazy" : "eager")" />
        }
        else
        {
            <div class="no-poster" style="@backgroundStyle">
                <span class="initials">@initials</span>
            </div>
        }
    </div>
    <div class="movie-info">
        
        <h3 data-testid="movie-title" class="movie-title">@cardTitle</h3>
        <div class="movie-meta @(Movie.OriginCountryCodes.Count > 1 ? "multi-country" : "")">
            @if (!string.IsNullOrEmpty(Movie.Year))
            {
                <span data-testid="movie-year" class="movie-year">@Movie.Year</span>
            }
            @{
                var cardCountries = CountryLookup.GetCountryNames(Movie.OriginCountryCodes);
            }
            @if (cardCountries.Count > 0)
            {
                <span class="movie-countries">@string.Join(", ", cardCountries)</span>
            }
        </div>
        <div class="movie-ratings">
            <RatingBadges Movie="@Movie" Compact="true" />
        </div>
    </div>

@code {
    private string GetInitials(string title)
    {
        if (string.IsNullOrWhiteSpace(title)) return "?";
        var parts = title.Split(new[] { ' ', '\t', '-', ':' }, StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1)
        {
            var p = parts[0];
            return p.Length <= 2 ? p.ToUpperInvariant() : p.Substring(0, 2).ToUpperInvariant();
        }
        return (parts[0][0].ToString() + parts[1][0].ToString()).ToUpperInvariant();
    }

    private string GetGradientStyle(string seed)
    {
        if (seed == null) seed = string.Empty;
        byte[] hash;
        using (var md5 = System.Security.Cryptography.MD5.Create())
        {
            hash = md5.ComputeHash(System.Text.Encoding.UTF8.GetBytes(seed));
        }
        var h = hash[0] % 360;
        var s = 55 + (hash[1] % 20); // 55-74
        var l = 42 + (hash[2] % 16); // 42-57
        var h2 = (h + 25 + (hash[3] % 40)) % 360;
        var s2 = Math.Max(40, s - 8);
        var l2 = Math.Min(70, l + 8);
        var c1 = $"hsl({h}, {s}%, {l}% )";
        var c2 = $"hsl({h2}, {s2}%, {l2}% )";
        return $"background: linear-gradient(135deg, {c1}, {c2}); color: white;";
    }
}
</div>
