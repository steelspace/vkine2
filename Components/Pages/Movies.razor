@page "/"
@page "/movies"
@rendermode InteractiveServer

<PageTitle>Movies</PageTitle>

<div class="sticky-toolbar" @ref="_toolbarRef">
    <div class="sticky-toolbar-inner">
        <div data-testid="toolbar-search" class="search-field">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input data-testid="search-input" class="search-input" placeholder="Search movies, descriptions, cast and crew" aria-label="Search movies, descriptions, cast and crew" @oninput="OnSearchInput" @onkeydown="OnKeyDownSearch" value="@searchQuery" />
            @if (!string.IsNullOrEmpty(searchQuery) && !isSearching)
            {
                <button data-testid="search-clear" class="search-clear-btn" @onclick="ClearSearch" title="Clear search">
                    <svg width="10" height="10" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <line x1="1" y1="1" x2="11" y2="11"/>
                        <line x1="11" y1="1" x2="1" y2="11"/>
                    </svg>
                </button>
            }
            @if (isSearching)
            {
                <div data-testid="search-spinner" class="search-spinner"></div>
            }
        </div>

        <div class="toolbar-row">
            <div class="date-range-picker">
                <svg class="filter-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <input data-testid="date-range-input" @ref="_dateRangeInput" class="date-range-input" placeholder="Date range" aria-label="Date range" readonly />
                @if (_dateFrom.HasValue)
                {
                    <button data-testid="date-clear" class="date-clear-btn" @onclick="ClearDateRange" title="Clear date filter">
                        <svg width="10" height="10" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                            <line x1="1" y1="1" x2="11" y2="11"/>
                            <line x1="11" y1="1" x2="1" y2="11"/>
                        </svg>
                    </button>
                }
            </div>

<div data-testid="time-filter" class="time-filter">
                <div class="time-filter-header">
                    <span id="time-filter-label" class="time-filter-label">After</span>
                    <span id="time-filter-value" class="time-filter-value @(_timeFromMinutes > 0 ? "active" : "")">@TimeFromLabel</span>
                </div>
                <input data-testid="time-slider" type="range" class="time-slider" min="540" max="1410" step="30"
                       value="@_timeFromMinutes" @oninput="OnTimeFromInput" aria-labelledby="time-filter-label" aria-describedby="time-filter-value" />
            </div>

            @if (_isDateFiltering)
            {
                <div class="search-spinner"></div>
            }

            <div data-testid="sort-group" class="sort-group">
                <span class="sort-label">Sort</span>
                <div class="segmented-control">
                    <button data-testid="sort-rating" class="segment @(_currentSort == SortField.Rating ? "active" : "")"
                            @onclick="() => ToggleSort(SortField.Rating)">
                        <span>★ Rating</span>
                        @if (_currentSort == SortField.Rating)
                        {
                            <span class="sort-arrow">@(_sortAscending ? "▲" : "▼")</span>
                        }
                    </button>
                    <button data-testid="sort-name" class="segment @(_currentSort == SortField.Name ? "active" : "")"
                            @onclick="() => ToggleSort(SortField.Name)">
                        <span>Name</span>
                        @if (_currentSort == SortField.Name)
                        {
                            <span class="sort-arrow">@(_sortAscending ? "▲" : "▼")</span>
                        }
                    </button>
                    <button data-testid="sort-year" class="segment @(_currentSort == SortField.ReleaseDate ? "active" : "")"
                            @onclick="() => ToggleSort(SortField.ReleaseDate)">
                        <span>Year</span>
                        @if (_currentSort == SortField.ReleaseDate)
                        {
                            <span class="sort-arrow">@(_sortAscending ? "▲" : "▼")</span>
                        }
                    </button>
                </div>
                @if (_isSortLoading)
                {
                    <div data-testid="sort-spinner" class="search-spinner"></div>
                }
            </div>
        </div>
    </div>
</div>

<div data-testid="movies-container" class="movies-container">

    @if (!string.IsNullOrWhiteSpace(searchQuery))
    {
        <div data-testid="movies-stats" class="movies-stats">
            <p data-testid="results-count">@searchResults.Count results</p>
        </div>

        <div data-testid="movies-grid" class="movies-grid">
            @foreach (var movie in searchResults)
            {
                <div data-testid="movie-card" class="movie-card" @onclick="() => OpenModal(movie)">
                    <div class="movie-poster">
                        @if (!string.IsNullOrEmpty(movie.CoverUrl))
                        {
                            <img data-testid="movie-poster-img" src="@movie.CoverUrl" alt="@movie.Title" />
                        }
                        else
                        {
                            <div class="no-poster">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/>
                                    <line x1="7" y1="2" x2="7" y2="22"/>
                                    <line x1="17" y1="2" x2="17" y2="22"/>
                                    <line x1="2" y1="12" x2="22" y2="12"/>
                                </svg>
                            </div>
                        }
                    </div>
                    <div class="movie-info">
                        <h3 data-testid="movie-title" class="movie-title">@movie.Title</h3>
                        <div class="movie-meta">
                            @if (!string.IsNullOrEmpty(movie.Year))
                            {
                                <span data-testid="movie-year" class="movie-year">@movie.Year</span>
                            }
                            @if (movie.OriginCountries.Count > 0)
                            {
                                <span class="movie-countries">@string.Join(", ", movie.OriginCountries)</span>
                            }
                        </div>
                        <div class="movie-ratings">
                            @if (movie.Id > 0)
                            {
                                <a data-testid="rating-csfd" href="https://www.csfd.cz/film/@movie.Id" target="_blank" class="rating-badge csfd" @onclick:stopPropagation title="CSFD rating">
                                    <span class="rating-source">ČSFD</span>
                                    @if (!string.IsNullOrEmpty(movie.CsfdRating))
                                    {
                                        <span class="rating-value">@movie.CsfdRating</span>
                                    }
                                </a>
                            }
                            @if (movie.TmdbId.HasValue)
                            {
                                <a data-testid="rating-tmdb" href="https://www.themoviedb.org/movie/@movie.TmdbId" target="_blank" class="rating-badge tmdb" @onclick:stopPropagation title="TMDB rating">
                                    <span class="rating-source">TMDB</span>
                                    @if (movie.TmdbRating.HasValue)
                                    {
                                        <span class="rating-value">@movie.TmdbRating.Value.ToString("0.#")</span>
                                    }
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(movie.ImdbId))
                            {
                                <a data-testid="rating-imdb" href="https://www.imdb.com/title/@movie.ImdbId" target="_blank" class="rating-badge imdb" @onclick:stopPropagation title="@(movie.ImdbRatingCount.HasValue ? $"IMDb rating ({movie.ImdbRatingCount.Value:N0} votes)" : "View on IMDb")">
                                    <span class="rating-source">IMDb</span>
                                    @if (movie.ImdbRating.HasValue)
                                    {
                                        <span class="rating-value">@movie.ImdbRating.Value.ToString("0.#")</span>
                                    }
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (isLoading)
    {
        <div data-testid="loading-container" class="loading-container">
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <p>Loading movies…</p>
        </div>
    }
    else
    {
        <div data-testid="movies-stats" class="movies-stats">
            <p data-testid="all-movies-count">
                @AllMovieIds.Count movies
                @if (_dateFrom.HasValue && _dateTo.HasValue)
                {
                    <span class="stats-date-range">@_dateFrom.Value.ToString("MMM d") – @_dateTo.Value.ToString("MMM d, yyyy")</span>
                }
            </p>
        </div>

        <div data-testid="movies-grid" class="movies-grid" @ref="_gridRef">
            @foreach (var movieId in AllMovieIds)
            {
                var movie = GetLoadedMovie(movieId);
                @if (movie is not null)
                {
                    <div data-testid="movie-card" class="movie-card loaded" data-movie-id="@movieId" @onclick="() => OpenModal(movie)">
                        <div class="movie-poster">
                            @if (!string.IsNullOrEmpty(movie.CoverUrl))
                            {
                                <img data-testid="movie-poster-img" src="@movie.CoverUrl" alt="@movie.Title" loading="lazy" />
                            }
                            else
                            {
                                <div data-testid="movie-poster-noposter" class="no-poster">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/>
                                        <line x1="7" y1="2" x2="7" y2="22"/>
                                        <line x1="17" y1="2" x2="17" y2="22"/>
                                        <line x1="2" y1="12" x2="22" y2="12"/>
                                    </svg>
                                </div>
                            }
                        </div>
                        <div class="movie-info">
                            <h3 data-testid="movie-title" class="movie-title">@movie.Title</h3>
                            <div class="movie-meta">
                                @if (!string.IsNullOrEmpty(movie.Year))
                                {
                                    <span data-testid="movie-year" class="movie-year">@movie.Year</span>
                                }
                                @if (movie.OriginCountries.Count > 0)
                                {
                                    <span class="movie-countries">@string.Join(", ", movie.OriginCountries)</span>
                                }
                            </div>
                            <div class="movie-ratings">
                                @if (movie.Id > 0)
                                {
                                    <a data-testid="rating-csfd" href="https://www.csfd.cz/film/@movie.Id" target="_blank" class="rating-badge csfd" @onclick:stopPropagation title="CSFD rating">
                                        <span class="rating-source">ČSFD</span>
                                        @if (!string.IsNullOrEmpty(movie.CsfdRating))
                                        {
                                            <span class="rating-value">@movie.CsfdRating</span>
                                        }
                                    </a>
                                }
                                @if (movie.TmdbId.HasValue)
                                {
                                    <a data-testid="rating-tmdb" href="https://www.themoviedb.org/movie/@movie.TmdbId" target="_blank" class="rating-badge tmdb" @onclick:stopPropagation title="TMDB rating">
                                        <span class="rating-source">TMDB</span>
                                        @if (movie.TmdbRating.HasValue)
                                        {
                                            <span class="rating-value">@movie.TmdbRating.Value.ToString("0.#")</span>
                                        }
                                    </a>
                                }
                                @if (!string.IsNullOrEmpty(movie.ImdbId))
                                {
                                    <a data-testid="rating-imdb" href="https://www.imdb.com/title/@movie.ImdbId" target="_blank" class="rating-badge imdb" @onclick:stopPropagation title="@(movie.ImdbRatingCount.HasValue ? $"IMDb rating ({movie.ImdbRatingCount.Value:N0} votes)" : "View on IMDb")">
                                        <span class="rating-source">IMDb</span>
                                        @if (movie.ImdbRating.HasValue)
                                        {
                                            <span class="rating-value">@movie.ImdbRating.Value.ToString("0.#")</span>
                                        }
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div data-testid="movie-card-placeholder" class="movie-card placeholder" data-movie-id="@movieId">
                        <div class="movie-poster">
                            <div class="poster-skeleton"></div>
                        </div>
                        <div class="movie-info">
                            <div class="title-skeleton"></div>
                            <div class="countries-skeleton"></div>
                        </div>
                    </div>
                }
            }
        </div>
    }

</div>

<MovieModal IsOpen="@isModalOpen" Movie="@selectedMovie" OnClose="@CloseModal"
            DateFrom="@_dateFrom" DateTo="@_dateTo" TimeFrom="@TimeFromValue" />
