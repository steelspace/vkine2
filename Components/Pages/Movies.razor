@page "/movies"
@inject IMovieService MovieService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>Virtualized Table</PageTitle>

@if (false) { }
else
{
    <div>
        <Virtualize @ref="virtualizeComponent" ItemsProvider="@LoadMovieRows" Context="row">
            <ItemContent>
                <div class="movie-row">
                    @foreach (var movie in row)
                    {
                        <div class="movie-card" @onclick="() => ShowMovieDetail(movie)">
                            <img src="@movie.CoverUrl" alt="@movie.Title" />
                            <div class="movie-title">@movie.Title</div>
                        </div>
                    }
                    @* Fill remaining space with invisible items to maintain alignment *@
                    @for (int i = 0; i < ItemsPerRow - row.Count; i++)
                    {
                        <div class="movie-card" style="visibility: hidden;"></div>
                    }
                </div>
            </ItemContent>
            <Placeholder>
                <div class="movie-row placeholder">
                    Loading...
                </div>
            </Placeholder>
        </Virtualize>
    </div>

    @if (selectedMovie != null)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <h2>@selectedMovie.Title</h2>
                <img src="@selectedMovie.CoverUrl" alt="@selectedMovie.Title" style="max-width: 100%; height: auto;" />
                <p>@selectedMovie.Synopsis</p>
                <button @onclick="CloseModal">Close</button>
            </div>
        </div>
    }
}

@code {
    private Movie? selectedMovie;
    private int ItemsPerRow = 4;
    private Virtualize<List<Movie>>? virtualizeComponent;
    private DotNetObjectReference<Movies>? selfReference;
    private IJSObjectReference? jsModule;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            selfReference = DotNetObjectReference.Create(this);
            // Inject a simple resize handler
            await JSRuntime.InvokeVoidAsync("eval", @"
                window.resizeListener = (dotnetHelper) => {
                    const handler = () => {
                         dotnetHelper.invokeMethodAsync('OnResize', window.innerWidth);
                    };
                    window.addEventListener('resize', handler);
                    handler(); // Initial call
                };
            ");
            await JSRuntime.InvokeVoidAsync("resizeListener", selfReference);
        }
    }

    [JSInvokable]
    public async Task OnResize(int width)
    {
        // Card width 200px + 20px gap + extra padding buffer
        // (Width - 40px padding) / 220px stride
        var newItemsPerRow = Math.Max(1, (width - 40) / 220);
        
        if (newItemsPerRow != ItemsPerRow)
        {
            ItemsPerRow = newItemsPerRow;
            if (virtualizeComponent != null)
            {
                await virtualizeComponent.RefreshDataAsync();
            }
            await InvokeAsync(StateHasChanged);
        }
    }

    private async ValueTask<ItemsProviderResult<List<Movie>>> LoadMovieRows(ItemsProviderRequest request)
    {
        var totalMovies = await MovieService.GetTotalMovieCount();
        var totalRows = (int)Math.Ceiling(totalMovies / (double)ItemsPerRow);

        var startIndex = request.StartIndex * ItemsPerRow;
        var count = Math.Min(request.Count * ItemsPerRow, totalMovies - startIndex);
        
        if (count <= 0)
        {
             return new ItemsProviderResult<List<Movie>>(new List<List<Movie>>(), totalRows);
        }

        var movies = await MovieService.GetMovies(startIndex, count);
        var rows = new List<List<Movie>>();
        
        for (int i = 0; i < movies.Count; i += ItemsPerRow)
        {
            // Take up to ItemsPerRow, handle end of list
            rows.Add(movies.Skip(i).Take(ItemsPerRow).ToList());
        }

        return new ItemsProviderResult<List<Movie>>(rows, totalRows);
    }

    private void ShowMovieDetail(Movie movie)
    {
        selectedMovie = movie;
    }

    private void CloseModal()
    {
        selectedMovie = null;
    }

    public async ValueTask DisposeAsync()
    {
        if (selfReference != null)
        {
            // Cleanup standard event listener would require keeping the function reference in JS
            // For this quick implementation, we rely on page refresh clearing it
            selfReference.Dispose();
        }
    }
}
