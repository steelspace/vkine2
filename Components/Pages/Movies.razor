@page "/movies"
@rendermode InteractiveServer

<PageTitle>Movies</PageTitle>

<div class="movies-container">
    <h1 class="movies-title">Movies</h1>

    <div class="search-container">
        <input class="search-input" placeholder="Search movies, descriptions, cast and crew" @oninput="OnSearchInput" @onkeydown="OnKeyDownSearch" value="@searchQuery" />
        @if (isSearching)
        {
            <span class="search-loading">Searching...</span>
        }
    </div>

    <div class="filters-row">
        <div class="date-range-picker">
            <input @ref="_dateRangeInput" class="date-range-input" placeholder="Filter by date range" readonly />
            @if (_dateFrom.HasValue)
            {
                <button class="date-clear-btn" @onclick="ClearDateRange" title="Clear date filter">&times;</button>
            }
        </div>
        @if (_isDateFiltering)
        {
            <span class="search-loading">Filtering...</span>
        }
    </div>

    @if (!string.IsNullOrWhiteSpace(searchQuery))
    {
        <div class="movies-stats">
            <p>Search results: @searchResults.Count</p>
        </div>

        <div class="movies-grid">
            @foreach (var movie in searchResults)
            {
                <div class="movie-card" @onclick="() => OpenModal(movie)">
                    <div class="movie-poster">
                        @if (!string.IsNullOrEmpty(movie.CoverUrl))
                        {
                            <img src="@movie.CoverUrl" alt="@movie.Title" />
                        }
                        else
                        {
                            <div class="no-poster">
                                <span>No Image</span>
                            </div>
                        }
                    </div>
                    <div class="movie-info">
                        <h3 class="movie-title">@movie.Title</h3>
                        @if (movie.OriginCountries.Count > 0)
                        {
                            <p class="movie-countries">@string.Join(", ", movie.OriginCountries)</p>
                        }
                        <div class="movie-ratings">
                            @if (!string.IsNullOrEmpty(movie.CsfdRating))
                            {
                                <a href="https://www.csfd.cz/film/@movie.Id" target="_blank" class="rating-badge csfd" @onclick:stopPropagation title="CSFD rating">
                                    <span class="rating-source">ČSFD</span>
                                    <span class="rating-value">@movie.CsfdRating</span>
                                </a>
                            }
                            @if (movie.TmdbRating.HasValue)
                            {
                                <a href="https://www.themoviedb.org/movie/@movie.TmdbId" target="_blank" class="rating-badge tmdb" @onclick:stopPropagation title="TMDB rating">
                                    <span class="rating-source">TMDB</span>
                                    <span class="rating-value">@movie.TmdbRating.Value.ToString("0.#")</span>
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(movie.ImdbId))
                            {
                                <a href="https://www.imdb.com/title/@movie.ImdbId" target="_blank" class="rating-badge imdb" @onclick:stopPropagation title="View on IMDb">
                                    <span class="rating-source">IMDb</span>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading movies...</p>
        </div>
    }
    else
    {
        <div class="movies-stats">
            <p>
                @AllMovieIds.Count upcoming movies
                @if (_dateFrom.HasValue && _dateTo.HasValue)
                {
                    <span> — @_dateFrom.Value.ToString("MMM d") – @_dateTo.Value.ToString("MMM d, yyyy")</span>
                }
            </p>
        </div>

        <div class="movies-grid" @ref="_gridRef">
            @foreach (var movieId in AllMovieIds)
            {
                var movie = GetLoadedMovie(movieId);
                @if (movie is not null)
                {
                    <div class="movie-card loaded" data-movie-id="@movieId" @onclick="() => OpenModal(movie)">
                        <div class="movie-poster">
                            @if (!string.IsNullOrEmpty(movie.CoverUrl))
                            {
                                <img src="@movie.CoverUrl" alt="@movie.Title" loading="lazy" />
                            }
                            else
                            {
                                <div class="no-poster">
                                    <span>No Image</span>
                                </div>
                            }
                        </div>
                        <div class="movie-info">
                            <h3 class="movie-title">@movie.Title</h3>
                            @if (movie.OriginCountries.Count > 0)
                            {
                                <p class="movie-countries">@string.Join(", ", movie.OriginCountries)</p>
                            }
                            <div class="movie-ratings">
                                @if (!string.IsNullOrEmpty(movie.CsfdRating))
                                {
                                    <a href="https://www.csfd.cz/film/@movie.Id" target="_blank" class="rating-badge csfd" @onclick:stopPropagation title="CSFD rating">
                                        <span class="rating-source">ČSFD</span>
                                        <span class="rating-value">@movie.CsfdRating</span>
                                    </a>
                                }
                                @if (movie.TmdbRating.HasValue)
                                {
                                    <a href="https://www.themoviedb.org/movie/@movie.TmdbId" target="_blank" class="rating-badge tmdb" @onclick:stopPropagation title="TMDB rating">
                                        <span class="rating-source">TMDB</span>
                                        <span class="rating-value">@movie.TmdbRating.Value.ToString("0.#")</span>
                                    </a>
                                }
                                @if (!string.IsNullOrEmpty(movie.ImdbId))
                                {
                                    <a href="https://www.imdb.com/title/@movie.ImdbId" target="_blank" class="rating-badge imdb" @onclick:stopPropagation title="View on IMDb">
                                        <span class="rating-source">IMDb</span>
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="movie-card placeholder" data-movie-id="@movieId">
                        <div class="movie-poster">
                            <div class="poster-skeleton"></div>
                        </div>
                        <div class="movie-info">
                            <div class="title-skeleton"></div>
                            <div class="countries-skeleton"></div>
                        </div>
                    </div>
                }
            }
        </div>
    }

</div>

<MovieModal IsOpen="@isModalOpen" Movie="@selectedMovie" OnClose="@CloseModal" />
